{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'core/css/chat.css' %}">
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <h3 class="chat-title">
            <i class="fa-regular fa-comments" style="color: #3b82f6;"></i> 
            Chat with {{ other_user.username }}
        </h3>
        <a href="{% url 'dashboard' %}" class="back-link">
            <i class="fa-solid fa-arrow-left"></i> Back
        </a>
    </div>

    <div class="messages-area" id="msg-area">
        {% for msg in messages %}
        <div class="message-row">
            <div class="message-bubble {% if msg.sender == request.user %}msg-sent{% else %}msg-received{% endif %}">
                {{ msg.content }}
            </div>
        </div>
        {% endfor %}
    </div>

    <form method="POST" class="chat-input-area">
        {% csrf_token %}
        <input type="text" name="content" placeholder="Type a message..." required autocomplete="off">
        <button type="submit" class="btn btn-primary btn-send">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </form>
</div>

<script>
    const msgArea = document.getElementById("msg-area");
    const otherUserId = "{{ other_user.id }}"; 
    
    function scrollToBottom() {
        msgArea.scrollTop = msgArea.scrollHeight;
    }
    scrollToBottom();

    setInterval(function() {
        fetch(`/api/messages/${otherUserId}/`)
        .then(response => response.json())
        .then(data => {
            msgArea.innerHTML = ''; 
            data.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'message-row';
                const bubbleClass = msg.is_me ? 'msg-sent' : 'msg-received';
                div.innerHTML = `<div class="message-bubble ${bubbleClass}">${msg.content}</div>`;
                msgArea.appendChild(div);
            });
        });
    }, 2000);
    
    const chatBox = document.querySelector('.chat-box');
    chatBox.scrollTop = chatBox.scrollHeight;

</script>
{% endblock %}