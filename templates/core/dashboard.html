{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="section-header">
    <h2 class="section-title">My Skills</h2>
    
    <div class="grid-skills">
        {% for item in my_skills %}
        <div class="card skill-card {% if item.role == 'TEACH' %}teach{% else %}learn{% endif %}">
            <div class="skill-header">
                <h3 style="font-size: 1.1rem; margin-bottom: 5px;">{{ item.skill.name }}</h3>
                <a href="{% url 'delete_skill' item.id %}" style="color: #ef4444; font-size: 0.9rem;" onclick="return confirm('Delete skill?')">
                    <i class="fa-solid fa-trash"></i>
                </a>
            </div>
            <span class="skill-badge {% if item.role == 'TEACH' %}teach{% else %}learn{% endif %}">
                {{ item.get_role_display }}
            </span>
        </div>
        {% empty %}
        <p style="grid-column: 1/-1; text-align: center; color: #94a3b8;">
            You haven't added any skills yet. <a href="{% url 'add_skill' %}">Add one now!</a>
        </p>
        {% endfor %}
    </div>
</div>

<hr style="border:0; border-top:1px solid #e2e8f0; margin:2rem 0;">

<div class="dashboard-top">
    <h2 class="section-title" style="margin:0;">My Dashboard</h2>
    <a href="{% url 'edit_profile' %}" class="btn btn-outline" style="font-size: 0.9rem;">
        <i class="fa-solid fa-pen"></i> Edit Profile
    </a>
</div>

<div class="grid-dashboard">
    <div>
        <h3 class="column-header">Incoming Requests</h3>
        {% for req in incoming %}
        <div class="card request-card">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                {% if req.sender.profile.image %}
                    <img src="{{ req.sender.profile.image.url }}" class="profile-pic-small">
                {% else %}
                    <i class="fa-solid fa-circle-user" style="font-size: 2rem; color: #cbd5e1;"></i>
                {% endif %}
                <div>
                    <strong>{{ req.sender.username }}</strong>
                    <div style="font-size: 0.85rem; color: #64748b;">Wants to swap skills</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1rem;">
                <a href="{% url 'handle_request' req.id 'accept' %}" class="btn" style="flex: 1;">Accept</a>
                <a href="{% url 'handle_request' req.id 'decline' %}" class="btn btn-outline" style="flex: 1; border-color: #ef4444; color: #ef4444;">Decline</a>
            </div>
        </div>
        {% empty %}
        <p style="color: #94a3b8; font-style: italic;">No pending requests.</p>
        {% endfor %}
    </div>

    <div>
        <h3 class="column-header">Active Conversations</h3>
        {% for partner in chats %}
        <div class="card chat-card" style="display: flex; align-items: center; padding: 1rem; margin-bottom: 10px;">
            
            <div style="display: flex; align-items: center; gap: 12px; flex-grow: 1;">
                <div class="status-dot" style="background: #22c55e; width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;"></div>
                <strong style="font-size: 1rem; color: #1e293b;">{{ partner.username }}</strong>
                
                {% if partner.unread_count > 0 %}
                    <span style="background: #ef4444; color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; animation: pulse 2s infinite; white-space: nowrap;">
                        {{ partner.unread_count }} new
                    </span>
                {% endif %}
            </div>

            <div style="display: flex; align-items: center; gap: 15px; margin-left: 10px;">
                <a href="{% url 'chat' partner.id %}" class="btn btn-outline" style="padding: 0.5rem 1.2rem; font-size: 0.85rem; border-radius: 50px;">
                    Message
                </a>
                <a href="{% url 'delete_conversation' partner.id %}" style="color: #94a3b8; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#94a3b8'" onclick="return confirm('End conversation?')">
                    <i class="fa-solid fa-trash"></i>
                </a>
            </div>

        </div>
        {% empty %}
        <p style="color: #94a3b8; font-style: italic;">No active chats yet.</p>
        {% endfor %}
    </div>
</div>
<script>
    let currentRequestCount = {{ incoming|length }};
    let currentMessageCount = {{ unread_messages_count|default:0 }}; // You'll need to pass this from your dashboard view initially

    setInterval(function() {
        fetch("{% url 'check_updates' %}")
        .then(response => response.json())
        .then(data => {
            // If either count changes, refresh the page to show the notification
            if (data.pending_count !== currentRequestCount || data.unread_count !== currentMessageCount) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }, 3000);
</script>
{% endblock %}